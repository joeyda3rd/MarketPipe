name: Update Roadmap

on:
  push:
    branches: [ main ]
    paths:
      - 'src/**'
      - 'tests/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'src/**'
      - 'tests/**'
  workflow_dispatch:  # Allow manual trigger

jobs:
  update-roadmap:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-cov

    - name: Run roadmap analysis
      run: |
        python scripts/update_roadmap.py --verbose
      continue-on-error: true

    - name: Check for roadmap changes
      id: check-changes
      run: |
        if git diff --quiet TODO.md; then
          echo "changed=false" >> $GITHUB_OUTPUT
        else
          echo "changed=true" >> $GITHUB_OUTPUT
        fi

    - name: Commit updated roadmap
      if: steps.check-changes.outputs.changed == 'true' && github.event_name == 'push'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add TODO.md
        git commit -m "ğŸ¤– Auto-update roadmap based on codebase analysis

        - Updated task completion status
        - Refreshed test coverage statistics  
        - Detected new TODO/FIXME items
        
        Generated by scripts/update_roadmap.py"
        git push

    - name: Comment on PR with roadmap update
      if: steps.check-changes.outputs.changed == 'true' && github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const roadmapContent = fs.readFileSync('TODO.md', 'utf8');
          
          // Extract coverage info
          const coverageMatch = roadmapContent.match(/\*\*Current Test Coverage\*\*: ~(\d+)% overall/);
          const coverage = coverageMatch ? coverageMatch[1] : 'unknown';
          
          // Count completed tasks
          const completedTasks = (roadmapContent.match(/- \[x\]/g) || []).length;
          const totalTasks = (roadmapContent.match(/- \[[x ]\]/g) || []).length;
          
          const comment = `## ğŸ¤– Roadmap Analysis Updated

          This PR triggers the following roadmap changes:

          ğŸ“Š **Test Coverage**: ${coverage}% overall
          âœ… **Task Progress**: ${completedTasks}/${totalTasks} completed (${Math.round(completedTasks/totalTasks*100)}%)

          The updated roadmap reflects the current state of your changes. Review the [updated TODO.md](./TODO.md) to see how your work impacts the project roadmap.

          <details>
          <summary>ğŸ” View Roadmap Changes</summary>

          \`\`\`diff
          ${await exec.getExecOutput('git', ['diff', 'origin/main', 'TODO.md']).then(result => result.stdout)}
          \`\`\`

          </details>

          *Generated automatically by \`scripts/update_roadmap.py\`*`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

    - name: Upload roadmap artifact
      if: steps.check-changes.outputs.changed == 'true'
      uses: actions/upload-artifact@v3
      with:
        name: updated-roadmap
        path: TODO.md
        retention-days: 30 