name: CI

on:
  pull_request:
  push:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  ###############################################################
  # 1. SQLite job (default) – unchanged behaviour
  ###############################################################
  test-sqlite:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e '.[dev]'

      - name: Run tests (SQLite)
        run: |
          mkdir -p tmp/coverage
          pytest -q --cov=marketpipe --cov-branch

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: coverage-sqlite
          path: tmp/coverage

  ###############################################################
  # 2. Postgres job – new
  ###############################################################
  test-postgres:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    # Start a Postgres 15 service container
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: mp_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U postgres"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    env:
      # Async-pg SQLAlchemy style URL; asyncpg is already in extras[dev]
      DATABASE_URL: postgresql+asyncpg://postgres:postgres@localhost:5432/mp_test

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies (incl. asyncpg)
        run: |
          python -m pip install --upgrade pip
          pip install -e '.[dev]'          # asyncpg pulled in via extras

      # Safety: wait a few extra seconds so pg_isready finishes
      - name: Wait for Postgres
        run: sleep 5

      # Alembic migrations are triggered by MarketPipe bootstrap,
      # but running them once here gives earlier failure visibility
      - name: Apply migrations
        run: |
          for i in {1..5}; do
            echo "Migration attempt $i/5..."
            alembic upgrade head && break || {
              echo "Migration failed, retrying in 5 seconds..."
              sleep 5
            }
          done

      - name: Run tests (Postgres)
        run: |
          mkdir -p tmp/coverage
          pytest -q -m "not sqlite_only" --cov=marketpipe --cov-branch

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: coverage-postgres
          path: tmp/coverage

  ###############################################################
  # 3. Combined coverage report
  ###############################################################
  coverage-report:
    runs-on: ubuntu-latest
    needs: [test-sqlite, test-postgres]
    if: always()  # Run even if some tests fail
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      - name: Install coverage tools
        run: |
          python -m pip install --upgrade pip
          pip install coverage==7.5
      
      - name: Download coverage artifacts
        uses: actions/download-artifact@v4
        with:
          path: tmp
      
      - name: Combine coverage files
        run: |
          mkdir -p tmp/coverage
          # Find and combine all .coverage.* files from artifacts
          find tmp/ -name ".coverage.*" -exec cp {} tmp/coverage/ \;
          cd tmp/coverage
          coverage combine
          coverage xml -o coverage.xml
          coverage html -d html
          coverage report --show-missing
      
      - name: Upload combined coverage artifact
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: coverage-combined
          path: tmp/coverage
      
      - name: Upload combined coverage to Codecov (optional)
        # Uncomment to enable Codecov integration
        # uses: codecov/codecov-action@v3
        # with:
        #   files: tmp/coverage/coverage.xml
        #   fail_ci_if_error: false
        run: echo "Coverage reports generated. Enable Codecov upload if needed." 