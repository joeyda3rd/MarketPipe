name: CI

on:
  pull_request:
  push:
    branches: [ main, develop ]

jobs:
  ###############################################################
  # 1. SQLite job (default) – unchanged behaviour
  ###############################################################
  test-sqlite:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e '.[dev]'

      - name: Run tests (SQLite)
        run: |
          pytest -q --cov=marketpipe --cov-report=xml

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: coverage-sqlite
          path: coverage.xml

  ###############################################################
  # 2. Postgres job – new
  ###############################################################
  test-postgres:
    runs-on: ubuntu-latest

    # Start a Postgres 15 service container
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: mp_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U postgres"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    env:
      # Async-pg SQLAlchemy style URL; asyncpg is already in extras[dev]
      DATABASE_URL: postgresql+asyncpg://postgres:postgres@localhost:5432/mp_test

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies (incl. asyncpg)
        run: |
          python -m pip install --upgrade pip
          pip install -e '.[dev]'          # asyncpg pulled in via extras

      # Safety: wait a few extra seconds so pg_isready finishes
      - name: Wait for Postgres
        run: sleep 5

      # Alembic migrations are triggered by MarketPipe bootstrap,
      # but running them once here gives earlier failure visibility
      - name: Apply migrations
        run: |
          for i in {1..5}; do
            echo "Migration attempt $i/5..."
            alembic upgrade head && break || {
              echo "Migration failed, retrying in 5 seconds..."
              sleep 5
            }
          done

      - name: Run tests (Postgres)
        run: |
          pytest -q -m "not sqlite_only" --cov=marketpipe --cov-append

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: coverage-postgres
          path: coverage.xml

  ###############################################################
  # 3. Combined coverage report (optional)
  ###############################################################
  coverage-report:
    runs-on: ubuntu-latest
    needs: [test-sqlite, test-postgres]
    if: always()  # Run even if some tests fail
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Download SQLite coverage
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: coverage-sqlite
          path: ./coverage-sqlite/
      
      - name: Download Postgres coverage  
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: coverage-postgres
          path: ./coverage-postgres/
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      - name: Install coverage tools
        run: |
          python -m pip install --upgrade pip
          pip install coverage
      
      - name: Combine coverage reports
        run: |
          echo "SQLite coverage:"
          if [ -f ./coverage-sqlite/coverage.xml ]; then
            head -20 ./coverage-sqlite/coverage.xml
          else
            echo "No SQLite coverage.xml found"
          fi
          echo -e "\nPostgres coverage:"
          if [ -f ./coverage-postgres/coverage.xml ]; then
            head -20 ./coverage-postgres/coverage.xml
          else
            echo "No Postgres coverage.xml found"
          fi
      
      - name: Upload combined coverage to Codecov (optional)
        # Uncomment to enable Codecov integration
        # uses: codecov/codecov-action@v3
        # with:
        #   files: ./coverage-sqlite/coverage.xml,./coverage-postgres/coverage.xml
        #   fail_ci_if_error: false
        run: echo "Coverage reports generated. Enable Codecov upload if needed." 