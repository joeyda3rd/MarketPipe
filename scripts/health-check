#!/bin/bash
# MarketPipe health check
# Usage: scripts/health-check

echo "ğŸ©º MarketPipe Health Check"
echo "=========================="

# Check Python version
echo "ğŸ Python version:"
python3 --version

# Check if MarketPipe is installed
echo ""
echo "ğŸ“¦ MarketPipe installation:"
if python3 -c "import marketpipe; print(f'âœ… MarketPipe {marketpipe.__version__}' if hasattr(marketpipe, '__version__') else 'âœ… MarketPipe (dev)')" 2>/dev/null; then
    echo "âœ… MarketPipe importable"
else
    echo "âŒ MarketPipe not installed or broken"
    echo "   Try: pip install -e ."
fi

# Check CLI availability
echo ""
echo "âš¡ CLI commands:"
if command -v marketpipe &> /dev/null; then
    echo "âœ… marketpipe CLI available"
    marketpipe --version 2>/dev/null || echo "âš ï¸  marketpipe CLI installed but --version failed"
else
    echo "âŒ marketpipe CLI not found"
    echo "   Try: pip install -e ."
fi

# Check key dependencies
echo ""
echo "ğŸ“š Dependencies:"
for dep in pandas duckdb pyarrow typer httpx; do
    if python3 -c "import $dep" 2>/dev/null; then
        echo "âœ… $dep"
    else
        echo "âŒ $dep (missing)"
    fi
done

# Check development dependencies
echo ""
echo "ğŸ”§ Development tools:"
for tool in pytest black; do
    if python3 -c "import $tool" 2>/dev/null; then
        echo "âœ… $tool"
    elif command -v $tool &> /dev/null; then
        echo "âœ… $tool (command)"
    else
        echo "âš ï¸  $tool (optional)"
    fi
done

# Check file watchers for scripts/watch
echo ""
echo "ğŸ‘€ File watchers:"
if command -v ptw &> /dev/null; then
    echo "âœ… pytest-watch"
elif command -v entr &> /dev/null; then
    echo "âœ… entr"
elif command -v inotifywait &> /dev/null; then
    echo "âœ… inotifywait"
else
    echo "âš ï¸  No file watcher (optional for scripts/watch)"
fi

# Check configuration
echo ""
echo "âš™ï¸  Configuration:"
if [ -f "config.yaml" ]; then
    echo "âœ… config.yaml exists"
else
    echo "âš ï¸  config.yaml missing (run scripts/setup)"
fi

if [ -f ".env" ]; then
    echo "âœ… .env exists"
else
    echo "âš ï¸  .env missing (run scripts/setup)"
fi

# Quick functional test
echo ""
echo "ğŸ§ª Quick functional test:"
if python3 -c "
import marketpipe
# Try to import key modules
from marketpipe import cli
print('âœ… All core modules importable')
" 2>/dev/null; then
    echo "âœ… Core functionality working"
else
    echo "âŒ Core functionality broken"
fi

echo ""
echo "ğŸ¯ Summary:"
echo "   Run 'scripts/setup' if you see any issues"
echo "   Run 'scripts/demo' to test end-to-end functionality" 